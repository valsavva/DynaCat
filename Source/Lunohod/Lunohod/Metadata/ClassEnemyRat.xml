<!--<Level xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="file:///D:/Lunohod/Documentation/schema0.xsd" Name="Lvl_1D_Boxes" Bounds="0, 0, 480, 320">-->
<Include>
    <Include File="ClassSmoke.xml" />

    <Class Id="clsEnemyRat">
		<Enemy IsExploding="true">

<!-- Init -->
            <BoolTrigger Id="this_trgInit1" Condition="@ratType==1" EnterAction="
                    this.Points=50;this.Damage=20;
                    @this_ERrest1FC=20;@this_ERrest2FC=20;
                    this_imgDefault.X=this_imgDefault.X-32;this_imgDefault.Y=this_imgDefault.Y-44;
                    this_sprAttack.X=this_sprAttack.X-32;this_sprAttack.Y=this_sprAttack.Y-44;
                    this_sprEnemyRatOnRest1.X=this_sprEnemyRatOnRest1.X-32;this_sprEnemyRatOnRest1.Y=this_sprEnemyRatOnRest1.Y-44;
                    this_sprEnemyRatOnRest2.X=this_sprEnemyRatOnRest2.X-32;this_sprEnemyRatOnRest2.Y=this_sprEnemyRatOnRest2.Y-44;
                    this_sprEnemyRatWalk.X=this_sprEnemyRatWalk.X-32;this_sprEnemyRatWalk.Y=this_sprEnemyRatWalk.Y-44;
                    this_imgEnemyRatDying.X=this_imgEnemyRatDying.X-32;this_imgEnemyRatDying.Y=this_imgEnemyRatDying.Y-44;
                    ">
            </BoolTrigger>

            <BoolTrigger Id="this_trgInit2" Condition="@ratType==2" EnterAction="
                    this.Points=50;this.Damage=20;
                    @this_ERrest1FC=20;@this_ERrest2FC=20;
                    this_imgDefault.X=this_imgDefault.X-32;this_imgDefault.Y=this_imgDefault.Y-45;
                    this_sprAttack.X=this_sprAttack.X-32;this_sprAttack.Y=this_sprAttack.Y-45;
                    this_sprEnemyRatOnRest1.X=this_sprEnemyRatOnRest1.X-32;this_sprEnemyRatOnRest1.Y=this_sprEnemyRatOnRest1.Y-45;
                    this_sprEnemyRatOnRest2.X=this_sprEnemyRatOnRest2.X-32;this_sprEnemyRatOnRest2.Y=this_sprEnemyRatOnRest2.Y-45;
                    this_sprEnemyRatWalk.X=this_sprEnemyRatWalk.X-32;this_sprEnemyRatWalk.Y=this_sprEnemyRatWalk.Y-45;
                    this_imgEnemyRatDying.X=this_imgEnemyRatDying.X-32;this_imgEnemyRatDying.Y=this_imgEnemyRatDying.Y-45;
                    ">
            </BoolTrigger>
            
            <BoolTrigger Id="this_trgInit3" Condition="@ratType==3" EnterAction="
                    this.Points=75;this.Damage=30;
                    @this_ERrest1FC=28;@this_ERrest2FC=28;
                    this_imgDefault.X=this_imgDefault.X-32;this_imgDefault.Y=this_imgDefault.Y-42;
                    this_sprAttack.X=this_sprAttack.X-32;this_sprAttack.Y=this_sprAttack.Y-42;
                    this_sprEnemyRatOnRest1.X=this_sprEnemyRatOnRest1.X-32;this_sprEnemyRatOnRest1.Y=this_sprEnemyRatOnRest1.Y-42;
                    this_sprEnemyRatOnRest2.X=this_sprEnemyRatOnRest2.X-32;this_sprEnemyRatOnRest2.Y=this_sprEnemyRatOnRest2.Y-42;
                    this_sprEnemyRatWalk.X=this_sprEnemyRatWalk.X-32;this_sprEnemyRatWalk.Y=this_sprEnemyRatWalk.Y-42;
                    this_imgEnemyRatDying.X=this_imgEnemyRatDying.X-32;this_imgEnemyRatDying.Y=this_imgEnemyRatDying.Y-42;
                    ">
            </BoolTrigger>
            
            <BoolTrigger Id="this_trgInit4" Condition="@ratType==4" EnterAction="
                    this.Points=75;this.Damage=30;
                    @this_ERrest1FC=20;@this_ERrest2FC=14;
                    this_imgDefault.X=this_imgDefault.X-32;this_imgDefault.Y=this_imgDefault.Y-41;
                    this_sprAttack.X=this_sprAttack.X-32;this_sprAttack.Y=this_sprAttack.Y-41;
                    this_sprEnemyRatOnRest1.X=this_sprEnemyRatOnRest1.X-32;this_sprEnemyRatOnRest1.Y=this_sprEnemyRatOnRest1.Y-41;
                    this_sprEnemyRatOnRest2.X=this_sprEnemyRatOnRest2.X-32;this_sprEnemyRatOnRest2.Y=this_sprEnemyRatOnRest2.Y-41;
                    this_sprEnemyRatWalk.X=this_sprEnemyRatWalk.X-32;this_sprEnemyRatWalk.Y=this_sprEnemyRatWalk.Y-41;
                    this_imgEnemyRatDying.X=this_imgEnemyRatDying.X-32;this_imgEnemyRatDying.Y=this_imgEnemyRatDying.Y-41;
                    ">
            </BoolTrigger>

            <BoolTrigger Id="this_trgInit7" Condition="@ratType==7" EnterAction="
                    this.Points=110;this.Damage=50;
                    @this_ERrest1FC=34;@this_ERrest2FC=44;
                    this_imgDefault.X=this_imgDefault.X-30;this_imgDefault.Y=this_imgDefault.Y-40;
                    this_sprAttack.X=this_sprAttack.X-30;this_sprAttack.Y=this_sprAttack.Y-40;
                    this_sprEnemyRatOnRest1.X=this_sprEnemyRatOnRest1.X-30;this_sprEnemyRatOnRest1.Y=this_sprEnemyRatOnRest1.Y-40;
                    this_sprEnemyRatOnRest2.X=this_sprEnemyRatOnRest2.X-30;this_sprEnemyRatOnRest2.Y=this_sprEnemyRatOnRest2.Y-40;
                    this_sprEnemyRatWalk.X=this_sprEnemyRatWalk.X-30;this_sprEnemyRatWalk.Y=this_sprEnemyRatWalk.Y-40;
                    this_imgEnemyRatDying.X=this_imgEnemyRatDying.X-30;this_imgEnemyRatDying.Y=this_imgEnemyRatDying.Y-40;
                    ">
            </BoolTrigger>

            <!-- Points Animation -->
            <Group Id="this_grpShowPoints" Bounds="0,0,100,50" Depth="0.2" Enabled="false">
                <!--<Do Action="this_grpShowPoints.X=this.X;this_grpShowPoints.Y=this.Y" InProgress="true" />-->
                <Text FontId="Splash14Font" Text="='+' + system.Str(this.Points)" Location="6,-12" Color="#FFFFFF">
                    <SequenceSet RepeatCount="1" InProgress="true">
                        <ParallelSet RepeatCount="1">
                            <NumAnimation Target="this_grpShowPoints.Opacity" From="1" To="0.5" RepeatCount="1" Duration="1" Fill="Hold" />
                            <RandomSet RepeatCount="1" >
                                <NumAnimation Target="this_grpShowPoints.Y" From="0" To="-50" IsDelta="true" RepeatCount="1" Duration="1" Fill="Hold" />
                                <NumAnimation Target="this_grpShowPoints.Y" From="0" To="-40" IsDelta="true" RepeatCount="1" Duration="1" Fill="Hold" />
                            </RandomSet>
                            <RandomSet RepeatCount="1" >
                                <NumAnimation Target="this_grpShowPoints.X" From="-4" To="4" IsDelta="true" Autoreverse="true" RepeatCount="1.25" Duration="0.4" Fill="Hold" />
                                <NumAnimation Target="this_grpShowPoints.X" From="4" To="-4" IsDelta="true" Autoreverse="true" RepeatCount="1.25" Duration="0.4" Fill="Hold" />
                            </RandomSet>
                        </ParallelSet>
                        <Do Action="this.Disable()"/>
                    </SequenceSet>
                </Text>
            </Group>

<!-- Parachute animation-->

            <BoolTrigger Id="this_trgParashutes" Condition="tower:LevelWithParachutes" EnterAction="this.Y=this.Y-60;this.Opacity=0">
                <Image Id="this_imgParachute" TextureId="txr_parachute" Bounds="-14, -48, 53, 62"/>
                <SequenceSet InProgress="true">
                    <Delay Duration="system.Rnd(1,2)" />
                    <Do Action="this.Opacity=1;
                           this.RotationCenterX=14;
                           this.RotationCenterY=-30" />
                    <ParallelSet>
                        <Sound FileId="sndParachute_open" Volume="0.2" Pitch="0" Pan="0"/>
                        <NumAnimation Target="this.Y" From="0" To="60" IsDelta="true" Autoreverse="false" RepeatCount="1" Duration="1.6" Fill="End" />
                        <SequenceSet InProgress="true" RepeatCount="2" >
                            <NumAnimation Target="this.Rotation" From="0" To="-3" Autoreverse="true" Duration="0.2" Fill="End" RepeatCount="1" Smoothing="Smooth"/>
                            <NumAnimation Target="this.Rotation" From="0" To="3" Autoreverse="true" Duration="0.2" Fill="End" RepeatCount="1" Smoothing="Smooth"/>
                        </SequenceSet>
                    </ParallelSet>
                    <NumAnimation Target="this_imgParachute.Opacity" From="1" To="0" IsDelta="false" Autoreverse="false" RepeatCount="1" Duration="0.4" Fill="End" />
                    <Do Action="this_imgParachute.Disable();
                        this.RotationCenterX=0;
                        this.RotationCenterY=0;
                        this_trgParashutes.Disable()" />
                </SequenceSet>
            </BoolTrigger>

<!-- States -->

            <!-- explosion -->
            <!-- dying -->

            <Group Id="this_Smoke3" Class="clsSmoke" Location="-4,-2" ClassParams="@type=3" />
            <Group Id="this_Smoke4" Class="clsSmoke" Location="-4,-2" ClassParams="@type=4" />

            <BoolTrigger Condition="this:BoomClose" 
                         EnterAction="hero.AddScore(this.Points);
                         this_setDying.Start()" 
                         StayTriggered="true" 
                         Group="this_sttStates">
				<Image Id="this_imgEnemyRatDying" TextureId="txrEnemyRatDyingType_@ratType" Bounds="0,0,80,80" />
			</BoolTrigger>
            <ParallelSet Id="this_setDying" InProgress="false">
                <Do Action="hero:+sttGoodExplosion;this_grpShowPoints.Enable()"/>
                <Sound FileId="sndEnemyRat5Dying" Volume="0.5" Pitch="0" Pan="0" InProfress="true"/>
                <NumAnimation Target="this_imgEnemyRatDying.Opacity" From="1" To="0" Duration="0.2" Autoreverse="false" RepeatCount="1" Fill="End"/>
                <RandomSet>
                    <Do Action="this_Smoke3:Run" />
                    <Do Action="this_Smoke4:Run" />
                </RandomSet>
            </ParallelSet>


            <!-- attack -->
            <IntersectionTrigger ObjectId1="hero" ObjectId2="this" Action="this:IntersectHero" />
                
            <BoolTrigger Condition="hero.CanCollide and 
                                    this:IntersectHero and 
                                    not this_grpShowPoints.Enabled and 
                                    not hero.IsDead"
                         EnterAction="this.Attack();
                                    this_anmDamageDealing.Start()" 
                         ExitAction="this_anmDamageDealing.Stop();
                                    this:onRestTimerReset" 
                         Group="this_sttStates">
                
                    <Sprite Id="this_sprAttack" TextureId="txrEnemyRatAttackType_@ratType" Bounds="0,0,80,80" FrameBounds="0,0,80,80"/>
                    <NumAnimation From="0" To="5" Duration="0.75" Autoreverse="false" Target="this_sprAttack.CurrentFrame" RepeatCount="0" Fill="Reset" InProgress="true"/>
            </BoolTrigger>


            <SequenceSet Id="this_anmDamageDealing" RepeatCount="0">
                <Do Action="this_anmAttack.Start();hero:sttGottaDamage" />
                <Delay Duration="system.Rnd(0.7,1.3)" />
            </SequenceSet>

            <ParallelSet Id="this_anmAttack" RepeatCount="1">
                <Do Action="this.Attack()" />
                <RandomSet>
                    <Sound FileId="sndEnemyRat3Hit1" Volume="0.5" Pitch="0" Pan="0"/>
                    <Sound FileId="sndEnemyRat3Hit2" Volume="0.5" Pitch="0" Pan="0"/>
                    <Sound FileId="sndEnemyRat3Hit3" Volume="0.5" Pitch="0" Pan="0"/>
                    <Sound FileId="sndEnemyRat3Hit1" Volume="0.5" Pitch="0.2" Pan="0"/>
                    <Sound FileId="sndEnemyRat3Hit2" Volume="0.5" Pitch="0.3" Pan="0"/>
                    <Sound FileId="sndEnemyRat3Hit3" Volume="0.5" Pitch="-0.3" Pan="0"/>
                </RandomSet>
            </ParallelSet>

            <!-- on rest -->
            <BoolTrigger Condition="this:onRestTimerReset and not this:Walker" EnterAction="this:-onRest;this_onRestTimer.Start()" />

            <SequenceSet Id="this_onRestTimer" InProgress="true" RepeatCount="0">
                <Do Action="@this_delay=system.Rnd(10,30)" />
                <!--<Do Action="system.WriteLine(system.Str(@this_delay))" />-->
                <Delay Duration="@this_delay" />
                <Do Action="@this_restNum=system.Rnd(1,2);this:+onRest" />
            </SequenceSet>

            <BoolTrigger Condition="this:onRest and not this:Walker"
                         Group="this_sttStates">

                <NumTrigger Property="@this_restNum" Compare="G" Value="1.5" EnterAction="this_anmEnemyRatOnRest1.Start()">
                    <Sprite Id="this_sprEnemyRatOnRest1" TextureId="txrEnemyRat@ratType_OnRest1" Bounds="0,0,80,80"  FrameBounds="0,0,80,80" FrameCount="12" />
                    <SequenceSet Id="this_anmEnemyRatOnRest1" RepeatCount="1">
                        <NumAnimation From="0" To="@this_ERrest1FC" Duration="@this_ERrest1FC*0.125" Target="this_sprEnemyRatOnRest1.CurrentFrame" RepeatCount="1" Fill="Reset"/>
                        <Do Action="this:-onRest;this:onRestTimerReset" />
                    </SequenceSet>
                </NumTrigger>

                <NumTrigger Property="@this_restNum" Compare="LE" Value="1.5" EnterAction="this_anmEnemyRatOnRest2.Start()">
                    <Sprite Id="this_sprEnemyRatOnRest2" TextureId="txrEnemyRat@ratType_OnRest2" Bounds="0,0,80,80"  FrameBounds="0,0,80,80" FrameCount="12" />
                    <SequenceSet Id="this_anmEnemyRatOnRest2" RepeatCount="1">
                        <NumAnimation From="0" To="@this_ERrest2FC" Duration="@this_ERrest2FC*0.125" Target="this_sprEnemyRatOnRest2.CurrentFrame" RepeatCount="1" Fill="Reset"/>
                        <Do Action="this:-onRest;this:onRestTimerReset" />
                    </SequenceSet>
                </NumTrigger>

            </BoolTrigger>

            <!-- walk -->
            <BoolTrigger Condition="this:Walker" Group="this_sttStates">
                <Sprite Id="this_sprEnemyRatWalk" TextureId="txrEnemyRatWalkType_@ratType" Bounds="0,0,80,80"  FrameBounds="0,0,80,80" FrameCount="4" >
                    <NumAnimation From="0" To="3" Duration="0.5" Target="this_sprEnemyRatWalk.CurrentFrame" Fill="Reset" InProgress="true" RepeatCount="0"/>
                </Sprite>
            </BoolTrigger>

            <!-- default -->
			<BoolTrigger Group="this_sttStates">
				<Image Id="this_imgDefault" TextureId="txrEnemyRatDefaultType_@ratType" Bounds="0,0,80,80"/>
			</BoolTrigger>
			
		</Enemy>
	</Class>

</Include>